---
layout: post
title: Water
---

Right.

So nothing much has been updated on this site for a while, which is a pity, but a fair amount has happened on the project.

Last we saw, the ground was just getting itself started.  A number of things have happened since then, and surprisingly, most of them involve Perlin noise.

Now Perlin noise is something I only recently came across, but it is pretty nifty.  The idea is that we want a smooth, noisy function.  Random functions (such as the amazing three liner:
    
    float random(int n)
    {
      n=(n<<13)^n;
      int nn=(n*(n*n*15731+789221)+1376312589)&0x7fffffff;
      return abs(1.0-(nn/1073741824.0));
    } 

give discrete noise.  Two good images to describe the difference are these (images from [here][1])

![Discrete Noise](http://freespace.virgin.net/hugo.elias/models/noise1.gif)
![Smooth Noise](http://freespace.virgin.net/hugo.elias/models/noise2.gif)

Now imagine it in two dimensions.  Why is this useful, you may ask.  Well, with some playing around with Perlin noise in the alpha and greyscale channels of a quadrilateral you can get an image like this:

![Texture](http://rspencer01.github.com/Project-Magrathea-V2/assets/cloud_texture.png)

Which is perfect for... clouds!

![Clouds](http://rspencer01.github.com/Project-Magrathea-V2/assets/clouds.jpg)

A little coding also gave a sun and a bunch of stars, giving a rather nice night scene:

![Night](http://rspencer01.github.com/Project-Magrathea-V2/assets/stars.jpg)

For a long time after this, I spent my time trying to optimise my code.  Some things that I did (in case anybody else is wondering how to do the same):

  * Only render things that will be visible.  No, really.  Simply calculate `dot(norm(objectPos-cameraPos) , cameraViewDir)` to work out the angle from the viewing direction to the object.   Don't render it if it is more than a certain limit.  One caveat is that you should render everything withing a certain distance of you, so overhanging branches don't just dissapear!
  * Don't go for fancy datastructures if a simple one will do.  Even if it might scale to a square lightyear of terrain easily, it is probably not required and will just end up breaking.  Keep it simple! (cough, cough, static array)
  * Do as much in shader as possible (see the later talk on water).
  * Don't update OpenGL buffers if at all possible not to.
  * Don't go setting dozens of uniform variables per frame.  Look up uniform buffers.  Seriously.

Ok, so I alluded to it above, but the really big visual improvement in V2.1.0 is water.  After manhandling Perlin noise into my vertex shader, I was able to displace the surface of the `Water` object with time.  This and Phong lighting gave the most pleasing

![Water](http://rspencer01.github.com/Project-Magrathea-V2/assets/water.jpg)

Note that the terrain is now generated by Perlin noise as well!  No more pulling in of real world data!

Then came a lot of head butting and slow progress, but eventually I managed to cull all rendering above a certain y value, invert about a plane, render to a texture and distort, giving my greates accievement so far, reflective water!

![Reflective Water](http://rspencer01.github.com/Project-Magrathea-V2/assets/water2.jpg)

Since that took a lot of energy (and the project is looking pretty good at the moment), I will not be spending too much time on it in the next little while, and that which I do spend, will go towards making it a lot faster (dynamic billboards and so forth).  Stay tuned!

[1]: http://freespace.virgin.net/hugo.elias/models/m_perlin.htm